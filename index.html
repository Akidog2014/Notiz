<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Personenerfassung</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      padding: 0;
      background-color: #f9f9f9;
    }

    .person-form, .zusatz-maske {
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 5px;
      background-color: #fff;
    }

    h1, h3 {
      text-align: center;
    }

    label {
      display: block;
      margin-top: 10px;
      font-size: 16px;
    }

    input, textarea {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      box-sizing: border-box;
      border-radius: 4px;
      border: 1px solid #ccc;
      margin-top: 5px;
    }

    button {
      display: block;
      width: 100%;
      padding: 12px;
      font-size: 16px;
      margin-top: 15px;
      border: none;
      border-radius: 5px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }

    button:hover {
      background-color: #0056b3;
    }

    .zusatzfelder, .aussagenfelder, .aussage-hinweis {
      margin-top: 10px;
      padding: 10px;
      border-left: 3px solid #007bff;
      background-color: #f1f8ff;
      border-radius: 5px;
      display: none;
    }

    .aussage-hinweis {
      background-color: #fff3cd !important;
      border-left: 4px solid #ffcc00 !important;
    }

    @media (min-width: 600px) {
      .person-form, .zusatz-maske {
        max-width: 600px;
        margin: 0 auto 20px auto;
      }

      button {
        max-width: 600px;
        margin: 20px auto;
      }
    }
  </style>
</head>
<body>

<h1>Personalienblatt</h1>

<div id="formContainer"></div>

<button onclick="weiter()">‚ûï Neue Person hinzuf√ºgen</button>
<button onclick="zeigeZusatzMaske()">üì§ Abschicken (Mail senden)</button>

<div id="zusatzMaske" class="zusatz-maske" style="display: none;">
  <h3>Zus√§tzliche Informationen</h3>
  <label>Aktuelles Datum: <input type="text" id="datum" readonly></label>
  <label>Zeit: <input type="time" id="zeit"></label>
  <label>Ereignis: <input type="text" id="ereignis"></label>
  <button onclick="finaleMailAbschicken()">‚úÖ Jetzt wirklich abschicken</button>
</div>

<script>
  const alleDaten = [];
  let formIndex = 0;

  function neuesFormular() {
    const container = document.getElementById('formContainer');

    const div = document.createElement('div');
    div.className = 'person-form';
    div.innerHTML = `
      <h3>Person ${formIndex + 1}</h3>

      <label>Nachname:<input type="text" name="nachname" required></label>
      <label>Vorname:<input type="text" name="vorname" required></label>

      <label>Geburtsdatum:
        <input type="text" name="geburtsdatum" placeholder="DD.MM.JJJJ" inputmode="numeric" required oninput="formatDate(event)">
      </label>

      <button type="button" onclick="zeigeWeitereAngaben(this)">‚ûï Noch nicht erfasst im myAbi!</button>

      <div class="zusatzfelder">
        <label>Strasse:<input type="text" name="strasse"></label>
        <label>PLZ:<input type="text" name="plz"></label>
        <label>Ort:<input type="text" name="ort"></label>
        <label>Vorname Vater:<input type="text" name="vater_vorname"></label>
        <label>Nachname Vater:<input type="text" name="vater_nachname"></label>
        <label>Vorname Mutter:<input type="text" name="mutter_vorname"></label>
        <label>Nachname Mutter:<input type="text" name="mutter_nachname"></label>
        <label>Geburtsort:<input type="text" name="geburtsort"></label>
        <label>Heimatort:<input type="text" name="heimatort"></label>
        <label>Beruf:<input type="text" name="beruf"></label>
      </div>

      <button type="button" onclick="zeigeAussagenFeld(this)">üó£Ô∏è Aussagen erfassen</button>

      <div class="aussage-hinweis">
        <p><strong>Hinweis zur Aussage:</strong></p>
        <p>Gegen Sie ist ein Vorverfahren wegen ..... eingeleitet worden.</p>
        <ul>
          <li>Sie k√∂nnen Aussage und Mitwirkung verweigern. Ihre Aussagen k√∂nnen als Beweismittel verwendet werden.</li>
          <li>Sie k√∂nnen jederzeit eine Verteidigung nach freier Wahl und auf Ihre Kosten beiziehen oder eine amtliche Verteidigung beantragen.</li>
          <li>Sie haben das Recht mit Ihrer Verteidigung frei zu verkehren. Ihre Verteidigung kann bei der Einvernahme anwesend sein.</li>
          <li>Sie haben das Recht, einen √úbersetzer zu verlangen.</li>
        </ul>
      </div>

      <div class="aussagenfelder">
        <label>Datum Aussage: <input type="text" name="aussage_datum" readonly></label>
        <label>Zeit Aussage: <input type="time" name="aussage_zeit" readonly></label>
        <label>Aussage:</label>
        <textarea name="aussage_text" placeholder="Aussage hier einf√ºgen" rows="4"></textarea>
      </div>

      <label>Telefonnummer:<input type="tel" name="telefonnummer" required></label>

      <label>Notizen:</label>
      <textarea name="notizen" rows="4"></textarea>
    `;

    container.appendChild(div);
    formIndex++;
  }

  function formatDate(event) {
    let value = event.target.value;
    value = value.replace(/[^\d\.]/g, '');
    if (value.length > 2 && value[2] !== '.') value = value.slice(0, 2) + '.' + value.slice(2);
    if (value.length > 5 && value[5] !== '.') value = value.slice(0, 5) + '.' + value.slice(5);
    if (value.length > 10) value = value.slice(0, 10);
    event.target.value = value;
  }

  function zeigeWeitereAngaben(button) {
    const form = button.closest('.person-form');
    form.querySelector('.zusatzfelder').style.display = 'block';
    button.style.display = 'none';
  }

  function zeigeAussagenFeld(button) {
    const form = button.closest('.person-form');

    // Hinweistext anzeigen
    const hinweis = form.querySelector('.aussage-hinweis');
    hinweis.style.display = "block";

    const feld = form.querySelector('.aussagenfelder');

    // Zeit + Datum setzen
    const jetzt = new Date();
    const datum = jetzt.toLocaleDateString("de-CH");
    const zeit = jetzt.toLocaleTimeString("de-CH", { hour: '2-digit', minute: '2-digit' });

    form.querySelector('input[name="aussage_datum"]').value = datum;
    form.querySelector('input[name="aussage_zeit"]').value = zeit;

    feld.style.display = 'block';
    button.style.display = 'none';
  }

  neuesFormular();

  function weiter() {
    datenAusFormularenSpeichern();
    neuesFormular();
    window.scrollTo(0, document.body.scrollHeight);
  }

  function datenAusFormularenSpeichern() {
    const forms = document.getElementsByClassName('person-form');
    alleDaten.length = 0;

    for (const form of forms) {
      const daten = {
        vorname: form.querySelector('input[name="vorname"]').value,
        nachname: form.querySelector('input[name="nachname"]').value,
        geburtsdatum: form.querySelector('input[name="geburtsdatum"]').value,
        beruf: form.querySelector('input[name="beruf"]').value,
        telefonnummer: form.querySelector('input[name="telefonnummer"]').value,
        notizen: form.querySelector('textarea[name="notizen"]').value,

        hatZusatz: form.querySelector('.zusatzfelder').style.display === 'block',

        strasse: form.querySelector('input[name="strasse"]').value,
        plz: form.querySelector('input[name="plz"]').value,
        ort: form.querySelector('input[name="ort"]').value,
        vater_vorname: form.querySelector('input[name="vater_vorname"]').value,
        vater_nachname: form.querySelector('input[name="vater_nachname"]').value,
        mutter_vorname: form.querySelector('input[name="mutter_vorname"]').value,
        mutter_nachname: form.querySelector('input[name="mutter_nachname"]').value,
        geburtsort: form.querySelector('input[name="geburtsort"]').value,
        heimatort: form.querySelector('input[name="heimatort"]').value,

        aussage_datum: form.querySelector('input[name="aussage_datum"]').value,
        aussage_zeit: form.querySelector('input[name="aussage_zeit"]').value,
        aussage_text: form.querySelector('textarea[name="aussage_text"]').value,
      };

      alleDaten.push(daten);
    }
  }

  function zeigeZusatzMaske() {
    datenAusFormularenSpeichern();
    const heute = new Date().toLocaleDateString("de-CH");
    document.getElementById('datum').value = heute;
    document.getElementById('zusatzMaske').style.display = 'block';
    window.scrollTo(0, document.body.scrollHeight);
  }

  function finaleMailAbschicken() {
    const datum = document.getElementById('datum').value;
    const zeit = document.getElementById('zeit').value;
    const ereignis = document.getElementById('ereignis').value;

    const empfaenger = "marco.wueest@lu.ch";
    const betreff = `Personendaten ${datum} - ${ereignis}`;

    let mailBody = `Datum: ${datum}\nZeit: ${zeit}\nEreignis: ${ereignis}\n\nErfasste Personen:\n\n`;

    alleDaten.forEach((person, index) => {
      mailBody += `Person ${index + 1}:\n`;
      mailBody += `Vorname: ${person.vorname}\n`;
      mailBody += `Nachname: ${person.nachname}\n`;
      mailBody += `Geburtsdatum: ${person.geburtsdatum}\n`;

      if (person.hatZusatz) {
        mailBody += `\n--- Weitere Angaben ---\n`;
        mailBody += `Strasse: ${person.strasse}\n`;
        mailBody += `PLZ: ${person.plz}\n`;
        mailBody += `Ort: ${person.ort}\n`;
        mailBody += `Vater: ${person.vater_vorname} ${person.vater_nachname}\n`;
        mailBody += `Mutter: ${person.mutter_vorname} ${person.mutter_nachname}\n`;
        mailBody += `Geburtsort: ${person.geburtsort}\n`;
        mailBody += `Heimatort: ${person.heimatort}\n`;
        mailBody += `Beruf: ${person.beruf}\n`;
      }

      if (person.aussage_text.trim() !== "") {
        mailBody += `\n--- Aussagen ---\n`;
        mailBody += `Aussage-Datum: ${person.aussage_datum}\n`;
        mailBody += `Aussage-Zeit: ${person.aussage_zeit}\n`;
        mailBody += `Aussage: ${person.aussage_text}\n`;
      }

      mailBody += `\nTelefonnummer: ${person.telefonnummer}\n`;
      mailBody += `Notizen: ${person.notizen}\n\n`;
    });

    const mailtoLink = `mailto:${empfaenger}?subject=${encodeURIComponent(betreff)}&body=${encodeURIComponent(mailBody)}`;
    window.location.href = mailtoLink;
  }
</script>

</body>
</html>
